<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Halloween Intro</title>
<style>
  :root {
    --bg: #000000;
  }
  html,body {
    height: 100%;
    margin: 0;
    background: var(--bg);
    display: grid;
    place-items: center;
    overflow: hidden;
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
  }
  /* 表示領域 */
  .stage {
    width: min(90vw, 520px);
    aspect-ratio: 4/5;           /* だいたい縦長に */
    position: relative;
  }
  /* 画像レイヤ */
  #frame {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: contain;
    opacity: 0;
    transition: opacity .35s ease; /* フェード用 */
    image-rendering: auto;         /* きれいめ */
  }
  /* デバッグ（必要なら表示） */
  #log {
    position: fixed;
    left: 8px; bottom: 8px;
    background: rgba(0,0,0,.55);
    color: #ffa500;
    font-size: 12px;
    padding: 6px 8px;
    border-radius: 6px;
    max-width: 92vw;
    line-height: 1.35;
    display:none; /* 見たい時は block に */
    white-space: pre-wrap;
  }
</style>
</head>
<body>
  <div class="stage">
    <img id="frame" alt="sequence"/>
  </div>
  <div id="log"></div>

<script>
/* ========= 設定 ========= */
const IMG = (name)=>`images/${name}`;

// ここが演出の台本（順番/時間/フェード）
const steps = [
  { type:'bg',  color:'#000',           dur: 200 },
  { type:'img', src:IMG('pumpkin_off.png'),     dur:1000, fadeIn:true },
  { type:'img', src:IMG('pumpkin_half_1.png'),  dur:300 },
  { type:'img', src:IMG('pumpkin_half_2.png'),  dur:300 },
  { type:'img', src:IMG('pumpkin_on.png'),      dur:400 },
  { type:'img', src:IMG('pumpkin_half_2.png'),  dur:250 },
  { type:'img', src:IMG('pumpkin_on.png'),      dur:250 },
  { type:'img', src:IMG('pumpkin_half_2.png'),  dur:250 },
  { type:'img', src:IMG('pumpkin_half_1.png'),  dur:250 },
  { type:'img', src:IMG('pumpkin_off.png'),     dur:400,  fadeOut:true },

  { type:'bg',  color:'#000',           dur: 200 },
  { type:'img', src:IMG('door_closed.png'),     dur:900,  fadeIn:true },
  { type:'img', src:IMG('door_quarteropen.png'),dur:400 },
  { type:'img', src:IMG('door_half.png'),       dur:400 },
  { type:'img', src:IMG('door_open.png'),       dur:400 },
  { type:'img', src:IMG('door_fullopen.png'),   dur:500 },

  { type:'bg',  color:'#ffffff',        dur:700 },
  // final.png を用意したらフェードインして終了（無ければこの2行を削除）
  { type:'img', src:IMG('final.png'),          dur:1600, fadeIn:true },
  // 終了後に遷移（ギャラリーのURLに変更してOK）
  { type:'goto', href:'index.html', wait: 300 }
];

// ========= 以下は触らなくてOK =========
const frame = document.getElementById('frame');
const logEl = document.getElementById('log');

// 画像のプリロード（存在しないファイル名はここで404確認できる）
const toPreload = steps.filter(s=>s.type==='img').map(s=>s.src);
toPreload.forEach(src=>{
  const im = new Image();
  im.onload = ()=>dbg(`preloaded: ${src}`);
  im.onerror = ()=>dbg(`⚠️ NOT FOUND: ${src}`);
  im.src = src;
});

function dbg(msg){
  // 見たい時は CSS の display を block に
  logEl.textContent += msg + '\n';
}

function setBg(color){
  document.documentElement.style.setProperty('--bg', color);
}

function delay(ms){ return new Promise(res=>setTimeout(res, ms)); }

// メイン進行
(async function run(){
  for (const step of steps){
    if (step.type === 'bg'){
      setBg(step.color || '#000');
      // 背景切替の時は画像を一旦消すこともできる
      // frame.style.opacity = 0;
      await delay(step.dur || 0);
      continue;
    }
    if (step.type === 'img'){
      // フェードアウト指示なら先に消す
      if (step.fadeOut){
        frame.style.opacity = 0;
        await delay(350);
      }
      // 画像差し替え
      await setSrcWithLoad(step.src);
      // フェードイン
      if (step.fadeIn){
        frame.style.opacity = 1;
      } else {
        // 直置き（残像出るのが嫌なら true に）
        frame.style.opacity = 1;
      }
      await delay(step.dur || 0);
      continue;
    }
    if (step.type === 'goto'){
      await delay(step.wait || 0);
      location.href = step.href;
      return;
    }
  }
})().catch(e=>{
  dbg('ERROR: ' + e.message);
  console.error(e);
});

function setSrcWithLoad(src){
  return new Promise((resolve)=>{
    frame.style.opacity = 0;                 // 切替時に一瞬消す
    const img = new Image();
    img.onload = ()=>{
      frame.src = src;
      // 次のリフレームで不透明に（ふわっと）
      requestAnimationFrame(()=>requestAnimationFrame(()=>{
        frame.style.opacity = 1;
        resolve();
      }));
    };
    img.onerror = ()=>{
      dbg(`⚠️ load error: ${src}`);
      // 失敗しても進める
      resolve();
    };
    img.src = src;
  });
}
</script>
</body>
</html>
